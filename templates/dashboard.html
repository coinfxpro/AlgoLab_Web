{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <!-- Portföy Tablosu -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Portföy</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Sembol</th>
                            <th>Lot</th>
                            <th>Alış Maliyeti</th>
                            <th>Güncel Fiyat</th>
                            <th>Toplam Maliyet</th>
                            <th>Toplam Değer</th>
                            <th>Kar/Zarar</th>
                            <th>Kar/Zarar %</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for position in portfolio %}
                        <tr>
                            <td>{{ position.get('symbol', '-') }}</td>
                            <td>{{ position.get('lot', 0) }}</td>
                            <td>{{ "%.2f"|format(position.get('alis_maliyeti', 0)) }}</td>
                            <td>{{ "%.2f"|format(position.get('guncel_fiyat', 0)) }}</td>
                            <td>{{ "%.2f"|format(position.get('toplam_maliyet', 0)) }}</td>
                            <td>{{ "%.2f"|format(position.get('toplam_deger', 0)) }}</td>
                            <td class="{{ 'text-success' if position.get('kar_zarar', 0) > 0 else 'text-danger' }}">
                                {{ "%.2f"|format(position.get('kar_zarar', 0)) }}
                            </td>
                            <td class="{{ 'text-success' if position.get('kar_zarar_yuzde', 0) > 0 else 'text-danger' }}">
                                {{ "%.2f"|format(position.get('kar_zarar_yuzde', 0)) }}%
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Bekleyen Emirler -->
    <div class="card mt-4">
        <div class="card-header">
            <h5 class="mb-0">Bekleyen Emirler</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Referans</th>
                            <th>Sembol</th>
                            <th>Yön</th>
                            <th>Tip</th>
                            <th>Fiyat</th>
                            <th>Miktar</th>
                            <th>Kalan</th>
                            <th>Durum</th>
                            <th>İşlem</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders.bekleyen %}
                        <tr>
                            <td>{{ order.get('atpref', '-') }}</td>
                            <td>{{ order.get('ticker', '-') }}</td>
                            <td>{{ order.get('buysell', '-') }}</td>
                            <td>{{ order.get('pricetype', '-') }}</td>
                            <td>{{ order.get('waitingprice', '-') }}</td>
                            <td>{{ order.get('ordersize', '-') }}</td>
                            <td>{{ order.get('remainingsize', '-') }}</td>
                            <td>{{ order.get('description', '-') }}</td>
                            <td>
                                <button class="btn btn-danger btn-sm" onclick="cancelOrder('{{ order.get('atpref', '') }}')">
                                    İptal Et
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Son İşlemler -->
    <div class="card mt-4">
        <div class="card-header">
            <h5 class="mb-0">Son İşlemler</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Emir No</th>
                            <th>Sembol</th>
                            <th>İşlem</th>
                            <th>Fiyat</th>
                            <th>Lot</th>
                            <th>Durum</th>
                            <th>Tarih</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders.son_islemler %}
                        <tr>
                            <td>{{ order.get('id', '-') }}</td>
                            <td>{{ order.get('symbol', '-') }}</td>
                            <td>{{ order.get('direction', '-') }}</td>
                            <td>{{ order.get('price', 0) }}</td>
                            <td>{{ order.get('quantity', 0) }}</td>
                            <td>{{ order.get('status', '-') }}</td>
                            <td>{{ order.get('date', '-') }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
// Her 30 saniyede bir sayfayı yenile
setInterval(function() {
    location.reload();
}, 30000);

// Emir iptal fonksiyonu
function cancelOrder(orderId) {
    if (confirm('Bu emri iptal etmek istediğinize emin misiniz?')) {
        fetch('/cancel_order', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                order_id: orderId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Emir başarıyla iptal edildi.');
                location.reload();
            } else {
                alert('Emir iptal edilirken bir hata oluştu: ' + data.error);
            }
        })
        .catch(error => {
            alert('Bir hata oluştu: ' + error);
        });
    }
}
</script>
{% endblock %}
